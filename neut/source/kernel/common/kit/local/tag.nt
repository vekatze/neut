import {
  core.ref {make-ref, mutate, ref},
  this.kernel.common.location-tree {File-Loc, empty-location-tree, insert, location-tree},
  this.logger.hint {get-column, get-line, get-should-save-location, hint},
}

data tag-kit {
| _Tag-Kit(
    tag-map-ref: ref(location-tree),
  )
}

define make-tag-kit(): tag-kit {
  let tag-map-ref = make-ref(box {empty-location-tree});
  _Tag-Kit of {tag-map-ref}
}

define get-location-tree(k: tag-kit): meta location-tree {
  let _Tag-Kit(ref) = k;
  core.ref.extract(ref)
}

define insert-file-loc(k: &tag-kit, m-use: &hint, name-length: int, m-def: meta hint): unit {
  when get-should-save-location(m-use) {
    let l = get-line(m-use);
    let c = get-column(m-use);
    tie _Tag-Kit(ref) = k;
    mutate(ref, function (map) {
      box {
        letbox map = map;
        letbox l = quote {l};
        letbox c = quote {c};
        letbox name-length = quote {name-length};
        letbox m-def = m-def;
        insert(File-Loc, Pair(l, Pair(c, add-int(c, name-length))), m-def, map)
      }
    })
  }
}
