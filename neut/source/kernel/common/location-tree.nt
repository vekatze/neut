import {
  core.dictionary {dictionary},
  core.int.ord,
  this.language.common.definite-description {definite-description, local-locator-from-dd},
  this.language.common.external-name {External-Name, external-name},
  this.language.common.is-const-like {is-const-like},
  this.language.raw-term.raw-term {Loc, loc},
  this.logger.hint {hint},
}

inline line: type {
  int
}

inline column: type {
  int
}

inline col-from: type {
  int
}

inline col-to: type {
  int
}

inline def-symbol-len: type {
  int
}

inline col-interval: type {
  pair(col-from, col-to)
}

data symbol-name {
| Local(int, def-symbol-len)
| Global(definite-description, is-const-like)
| Foreign(external-name)
}

data loc-type {
| File-Loc
| Symbol-Loc(symbol-name)
}

data loc-item {
| Loc-Item(int, col-interval, loc-type, hint)
}

inline location-tree: type {
  dictionary(loc, loc-item)
}

inline ord-loc: ord(loc) {
  let Ord of {compare := !cmp-int} = core.int.ord.as-ord;
  Ord of {
    compare := {
      function (l1, l2) {
        tie Loc(x1, y1) = l1;
        tie Loc(x2, y2) = l2;
        match !cmp-int(x1, x2) {
        | EQ =>
          !cmp-int(y1, y2)
        | c =>
          c
        }
      }
    },
  }
}

define insert(k: &ord(loc), lt: loc-type, p: pair(line, col-interval), m: hint, t: location-tree): location-tree {
  let Pair(l, Pair(from, to)) = p;
  core.dictionary.insert(k, t, Loc(l, from), Loc-Item(l, Pair(from, to), lt, m))
}

define _get-length(s: &symbol-name): def-symbol-len {
  case s {
  | Local(_, len) =>
    *len
  | Global(dd, _) =>
    pin tmp = local-locator-from-dd(dd);
    core.text.length(tmp)
  | Foreign(External-Name(t)) =>
    core.text.length(t)
  }
}
