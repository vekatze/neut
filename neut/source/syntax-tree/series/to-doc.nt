import {
  core.list {is-empty},
  core.text {replicate},
  this.pretty-printer.doc {Empty, doc, indent, join, line, make-text, nest},
  this.pretty-printer.piece {append-comma-if-vertical, delimiter-bar, delimiter-left-aligned, inject, piece},
  this.syntax-tree.comment {comment},
  this.syntax-tree.comment.to-doc {as-clause-header, as-prefix, as-prefix-indented, as-suffix},
  this.syntax-tree.series {Bar, Comma, Series, get-separator-text, series},
}

inline _c-decode {
  this.syntax-tree.comment.to-doc.decode
}

define _decode-prefix<a>(s: &series(a)): doc {
  tie Series of {prefix} = s;
  case prefix {
  | Left(_) =>
    Empty
  | Right(Pair(p, c)) =>
    pin p = core.text.append(" ", p);
    let p = make-text(core.text.append(p, " "));
    if is-empty(c) {
      p
    } else {
      join[
        p,
        line,
        _c-decode(*c),
        line,
      ]
    }
  }
}

define _attach-comment(c: comment, d: doc): doc {
  join[as-prefix(c), d]
}

define _bar-seq-cont(
  elems: list(pair(comment, doc)),
  trailing-comment: comment,
): list(piece) {
  let sep = get-separator-text(Bar);
  match elems {
  | Nil =>
    List[inject(nest(indent, as-suffix(trailing-comment)))]
  | Cons(Pair(c, d), rest) =>
    core.list.append(
      List[
        inject(as-clause-header(c)),
        delimiter-bar(make-text(*sep)),
        inject(nest(indent, d)),
      ],
      _bar-seq-cont(rest, trailing-comment),
    )
  }
}

define _bar-seq(
  elems: list(pair(comment, doc)),
  is-vertical: bool,
  trailing-comment: comment,
): list(piece) {
  match elems {
  | Nil =>
    let b on trailing-comment = is-empty(trailing-comment);
    if b {
      List[inject(Empty)]
    } else {
      List[inject(join[
        make-text(replicate(" ", indent)),
        _c-decode(trailing-comment),
      ])]
    }
  | Cons(Pair(c, d), rest) =>
    let prefix =
      if is-vertical {
        let sep = get-separator-text(Bar);
        inject(make-text(core.text.append(sep, " ")))
      } else {
        inject(Empty)
      };
    let head-elem = List[inject(as-prefix-indented(c)), prefix, inject(nest(indent, d))];
    let rest = _bar-seq-cont(rest, trailing-comment);
    core.list.append(head-elem, rest)
  }
}

define _comma-seq-cont(elems: list(doc), is-vertical: bool, trailing-comment: comment): list(piece) {
  let sep = get-separator-text(Comma);
  match elems {
  | Nil =>
    List[inject(_c-decode(trailing-comment))]
  | Cons(d, Nil) =>
    if is-vertical {
      List[
        inject(d),
        inject(make-text(*sep)),
        inject(as-suffix(trailing-comment)),
      ]
    } else {
      List[
        append-comma-if-vertical(d),
        inject(as-suffix(trailing-comment)),
      ]
    }
  | Cons(d, rest) =>
    core.list.append(
      List[
        inject(d),
        delimiter-left-aligned(make-text(*sep)),
      ],
      _comma-seq-cont(rest, is-vertical, trailing-comment),
    )
  }
}
