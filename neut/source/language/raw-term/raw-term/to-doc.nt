import {
  this.language.raw-term.locator {text-from-locator},
  this.language.raw-term.name {Locator, Var, name},
  this.language.raw-term.raw-binder {Raw-Binder, raw-binder},
  this.language.raw-term.raw-ident {is-hole},
  this.language.raw-term.raw-term {Elem, Hole, Tau, elem, imp-params, raw-term},
  this.logger.hint {hint},
  this.pretty-printer.doc {Empty, Inline-Comment, Line, Text, _is-multi, doc, indent, is-multi, join, line, make-text, nest},
  this.pretty-printer.piece {arrange, inject, parameter},
  this.syntax-tree.comment {comment},
  this.syntax-tree.comment.to-doc {as-prefix, as-suffix},
  this.syntax-tree.series {for-each, series},
  this.syntax-tree.series.to-doc,
}

define doc-from-raw-term(e: &raw-term): doc {
  case e {
  | Tau(_) =>
    make-text(*"tau")
  | Hole(_, _) =>
    make-text(*"_")
  }
}

define attach-comment(c: comment, d: doc): doc {
  join[as-prefix(c), d]
}

define _decode-block(x: elem(doc)): doc {
  let Elem(c1, body, c2) = x;
  join[
    make-text(*"{"),
    nest(indent, join[line, attach-comment(c1, body), as-suffix(c2)]),
    make-text(*"}"),
  ]
}

define _doc-from-name(n: &name): doc {
  case n {
  | Var(var) =>
    if is-hole(var) {
      make-text(*"_")
    } else {
      make-text(*var)
    }
  | Locator(locator) =>
    make-text(text-from-locator(locator))
  }
}

define type-annot(t: doc): doc {
  let b on t = _is-multi(t);
  if b {
    join[make-text(*":"), line, t]
  } else {
    join[make-text(*": "), t]
  }
}

nominal {
  to-doc(t: &raw-term): doc,
}

data _param {
| _Param(hint, doc, comment, comment, raw-term)
}

define _param-to-doc(p: _param): doc {
  let _Param(_, x, c1, c2, t) = p;
  match t {
  | Hole of {} =>
    attach-comment(core.list.append(c1, c2), x)
  | t =>
    let d on t = to-doc(t);
    let _ = t;
    arrange(List[
      parameter(x),
      inject(attach-comment(core.list.append(c1, c2), type-annot(d))),
    ])
  }
}

define _imp-param-to-doc(x: pair(raw-binder(raw-term), ?raw-term)): doc {
  let Pair(Raw-Binder(m, x, c1, c2, t), maybe-default) = x;
  pin tmp = Var(x);
  let x = _doc-from-name(tmp);
  let base-param = _param-to-doc(_Param(m, x, c1, c2, t));
  match maybe-default {
  | Left(_) =>
    base-param
  | Right(default-value) =>
    pin default-value = default-value;
    join[
      base-param,
      make-text(*" := "),
      to-doc(default-value),
    ]
  }
}

define to-doc(t: &raw-term): doc {
  admit
}
